<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de ingreso por DNI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(0, 128, 255, 0.12), transparent 40%),
        radial-gradient(circle at 80% 0%, rgba(255, 99, 71, 0.08), transparent 40%),
        linear-gradient(135deg, #0f172a, #111827 45%, #0b1020 100%);
      color: #e2e8f0;
      padding: 2rem 1rem 3rem;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 1.5rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    h1 {
      font-size: clamp(2rem, 3vw + 1rem, 3.5rem);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin: 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(8px);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      letter-spacing: 0.02em;
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: start;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    input,
    button,
    select {
      width: 100%;
      padding: 0.75rem 0.9rem;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: #e2e8f0;
      font-size: 1rem;
    }

    input:focus,
    button:focus {
      outline: 2px solid #38bdf8;
      outline-offset: 1px;
    }

    button {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    button.primary {
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      border: none;
      color: #0b1020;
      box-shadow: 0 12px 30px rgba(6, 182, 212, 0.35);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.16);
    }

    button:hover {
      transform: translateY(-1px);
    }

    .message {
      padding: 0.85rem 1rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .message.success {
      border-color: rgba(34, 197, 94, 0.55);
      background: rgba(22, 163, 74, 0.15);
    }

    .message.error {
      border-color: rgba(248, 113, 113, 0.55);
      background: rgba(248, 113, 113, 0.12);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.green {
      background: #34d399;
    }

    .status-dot.red {
      background: #f87171;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: #cbd5e1;
      font-size: 0.95rem;
    }

    th,
    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      padding: 0.75rem 0.6rem;
      text-align: left;
    }

    th {
      color: #e2e8f0;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    #qr-region {
      width: 100%;
      min-height: 220px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px dashed rgba(255, 255, 255, 0.25);
      border-radius: 12px;
      display: grid;
      place-items: center;
      color: #cbd5e1;
      position: relative;
      overflow: hidden;
    }

    .actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .small {
      font-size: 0.9rem;
      color: #cbd5e1;
    }

    .muted {
      opacity: 0.8;
    }

    .scan-preview {
      padding: 0.9rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      display: grid;
      gap: 0.35rem;
    }

    .scan-preview .label {
      font-weight: 600;
      letter-spacing: 0.01em;
      opacity: 0.9;
    }

    .scan-preview .raw {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9rem;
      word-break: break-word;
      color: #cbd5e1;
    }

    .scan-preview .dni {
      font-weight: 700;
      font-size: 1.1rem;
      color: #38bdf8;
    }

    video.scanner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @media (max-width: 680px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div>
        <p class="small" style="margin:0 0 0.25rem; opacity:0.8;">Control en tiempo real</p>
        <h1>Control de ingresos por DNI</h1>
      </div>
      <div class="actions">
        <button class="secondary" id="download-btn" type="button">Descargar Excel (CSV)</button>
        <button class="secondary" id="upload-btn" type="button">游늭 Cargar listado</button>
        <input id="file-input" type="file" accept=".csv,.txt" style="display:none" />
      </div>
    </header>

    <div class="grid two">
        <section class="card">
          <h2>Escanear QR del DNI</h2>
          <p class="small">Usa la c치mara para leer el c칩digo del DNI argentino. El n칰mero detectado se validar치 en el listado.</p>
          <div class="grid">
            <div id="qr-region">La c치mara est치 apagada</div>
            <div class="grid">
              <div class="scan-preview">
                <div class="label">칔ltimo dato le칤do</div>
                <div id="qr-raw" class="raw muted">A칰n no se detecta un c칩digo.</div>
                <div id="qr-dni" class="dni"></div>
              </div>
              <div class="actions">
                <button class="primary" id="toggle-scan">Iniciar c치mara</button>
                <button class="secondary" id="confirm-scan" type="button" disabled>Confirmar DNI detectado</button>
              </div>
            </div>
          </div>
        </section>

      <section class="card">
        <h2>Ingresar DNI manualmente</h2>
        <div class="grid">
          <div>
            <label for="dni-input">DNI</label>
            <input id="dni-input" type="text" inputmode="numeric" autocomplete="off" placeholder="Ej: 12345678" />
          </div>
          <button class="primary" id="check-btn">Verificar y registrar ingreso</button>
          <div id="status" aria-live="polite"></div>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>Agregar persona autorizada</h2>
      <div class="grid two">
        <div>
          <label for="new-dni">DNI</label>
          <input id="new-dni" type="text" inputmode="numeric" placeholder="Ej: 20123456" />
        </div>
        <div>
          <label for="new-name">Nombre</label>
          <input id="new-name" type="text" placeholder="Nombre completo" />
        </div>
      </div>
      <div class="actions" style="margin-top:1rem;">
        <button class="secondary" id="add-btn">Agregar a la lista</button>
      </div>
      <p class="small" style="margin-top:0.75rem;">Si al iniciar la app no existe un archivo, se genera uno nuevo con las columnas DNI, Nombre, 칔ltimo check-in y Total ingresos.</p>
    </section>

    <section class="card">
      <h2>Listado registrado</h2>
      <div class="small" style="margin-bottom:0.5rem;">La informaci칩n se guarda en tu navegador y puedes descargarla como CSV compatible con Excel en cualquier momento.</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>DNI</th>
              <th>Nombre</th>
              <th>칔ltimo check-in</th>
              <th>Total ingresos</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>
  </div>

    <script>
      const STORAGE_KEY = "dni-checkin-data";
      let records = [];
      let cameraRunning = false;
      let stream = null;
      let detector = null;
      let scanHandle = null;
      let videoEl = null;
      let lastScannedDni = "";
      let lastScannedRaw = "";

      function normalizeDni(value) {
        return (value || "").replace(/\D/g, "");
      }

      function loadData() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            return JSON.parse(stored);
          }
        } catch (error) {
          console.warn("No se pudo leer el almacenamiento local", error);
        }
        return [];
      }

      function saveData() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        } catch (error) {
          console.warn("No se pudo guardar el listado", error);
        }
      }

      function renderTable() {
        const tbody = document.getElementById("table-body");
        tbody.innerHTML = "";
        records.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.dni}</td>
            <td>${item.name || ""}</td>
            <td>${item.lastCheck || ""}</td>
            <td>${item.total || 0}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function showMessage(message, type = "success") {
        const status = document.getElementById("status");
        status.innerHTML = `
          <div class="message ${type}">
            <span class="status-dot ${type === "success" ? "green" : "red"}"></span>
            <span>${message}</span>
          </div>
        `;
      }

      function updateScanPreview(rawText, dni) {
        const rawEl = document.getElementById("qr-raw");
        const dniEl = document.getElementById("qr-dni");
        const confirmBtn = document.getElementById("confirm-scan");

        lastScannedRaw = rawText || "";
        lastScannedDni = normalizeDni(dni);

        rawEl.textContent = lastScannedRaw || "A칰n no se detecta un c칩digo.";
        rawEl.classList.toggle("muted", !lastScannedRaw);

        if (lastScannedDni) {
          dniEl.textContent = `DNI detectado: ${lastScannedDni}`;
          confirmBtn.disabled = false;
        } else {
          dniEl.textContent = "No se identific칩 un DNI v치lido en el c칩digo.";
          confirmBtn.disabled = true;
        }
      }

      function registerEntry(dni) {
        const cleanDni = normalizeDni(dni);
        if (!cleanDni) {
          showMessage("Ingresa un DNI v치lido.", "error");
          return;
        }

        const person = records.find((row) => row.dni === cleanDni);
        if (!person) {
          showMessage("El DNI no existe en el listado. Agrega la persona autorizada para continuar.", "error");
          return;
        }

        const now = new Date();
        person.lastCheck = now.toLocaleString();
        person.total = (person.total || 0) + 1;
        saveData();
        renderTable();
        showMessage(`Ingreso registrado para DNI ${cleanDni}. Total ingresos: ${person.total}.`);
      }

      function addPerson() {
        const dni = normalizeDni(document.getElementById("new-dni").value);
        const name = document.getElementById("new-name").value.trim();
        if (!dni) {
          alert("Ingresa un DNI v치lido.");
          return;
        }

        const exists = records.some((row) => row.dni === dni);
        if (exists) {
          alert("Ese DNI ya est치 en la lista.");
          return;
        }

        records.push({ dni, name, lastCheck: "", total: 0 });
        saveData();
        renderTable();
        document.getElementById("new-dni").value = "";
        document.getElementById("new-name").value = "";
        showMessage("Persona agregada al listado.");
      }

    function parseCsv(text) {
      return text
        .trim()
        .split(/\r?\n/)
        .map((line) => line.split(",").map((cell) => cell.trim()));
    }

    function handleFileInput(event) {
      const file = event.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const rows = parseCsv(String(text));
          const [header, ...body] = rows;
          if (!header || normalizeDni(header[0]) !== "dni") {
            throw new Error("Formato incompatible. Usa un CSV con encabezados DNI,Nombre,칔ltimo check-in,Total ingresos.");
          }
          records = body
            .filter((row) => row.length)
            .map((row) => ({
              dni: normalizeDni(row[0]),
              name: row[1] || "",
              lastCheck: row[2] || "",
              total: Number(row[3]) || 0,
            }))
            .filter((item) => item.dni);
          saveData();
          renderTable();
          showMessage("Listado cargado correctamente.");
        } catch (error) {
          console.error("Error al leer el archivo subido", error);
          showMessage("El archivo no es v치lido o est치 da침ado. Intenta con otro CSV.", "error");
        } finally {
          event.target.value = "";
        }
      };
      reader.onerror = () => {
        showMessage("No se pudo leer el archivo seleccionado.", "error");
      };
      reader.readAsText(file);
    }

    function downloadData() {
      const header = "DNI,Nombre,칔ltimo check-in,Total ingresos";
      const body = records
        .map((row) => [row.dni, row.name || "", row.lastCheck || "", row.total || 0].join(","))
        .join("\n");
      const csvContent = `${header}\n${body}`;
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "registros_dni.csv";
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function extractDniFromText(text) {
      const payload = (text || "").trim();
      if (!payload) return "";

      const jsonMatch = payload.match(/\{.*\}/s);
      if (jsonMatch) {
        try {
          const data = JSON.parse(jsonMatch[0]);
          const dniCandidate = normalizeDni(data.dni || data.DNI || data.numero_documento || "");
          if (dniCandidate.length >= 7 && dniCandidate.length <= 9) return dniCandidate;
        } catch (error) {
          console.warn("No se pudo interpretar el JSON del QR", error);
        }
      }

      if (payload.includes("@")) {
        for (const part of payload.split("@")) {
          const dniCandidate = normalizeDni(part);
          if (dniCandidate.length >= 7 && dniCandidate.length <= 9) return dniCandidate;
        }
      }

      const dniMatch = payload.match(/(\d{7,9})/);
      if (dniMatch) return dniMatch[1];

      const dniLabel = payload.match(/DNI[:=]?(\d{7,9})/i);
      return dniLabel ? dniLabel[1] : "";
    }

      async function scanFrame() {
        if (!cameraRunning || !detector || !videoEl) return;
        try {
          const codes = await detector.detect(videoEl);
          const first = codes?.[0];
          if (first?.rawValue) {
            const extracted = extractDniFromText(first.rawValue);
            if (extracted) {
              document.getElementById("dni-input").value = extracted;
            }
            updateScanPreview(first.rawValue, extracted);
          }
        } catch (error) {
          console.warn("No se pudo leer el cuadro de la c치mara", error);
        }
        scanHandle = requestAnimationFrame(scanFrame);
      }

      function stopCamera() {
        if (scanHandle) cancelAnimationFrame(scanHandle);
        scanHandle = null;
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }
        if (videoEl) {
          videoEl.srcObject = null;
        }
        cameraRunning = false;
        updateScanPreview("", "");
        document.getElementById("qr-region").innerHTML = "La c치mara est치 apagada";
        document.getElementById("toggle-scan").textContent = "Iniciar c치mara";
      }

      async function toggleCamera() {
        const qrRegion = document.getElementById("qr-region");
        if (cameraRunning) {
          stopCamera();
          return;
        }

        if (!navigator.mediaDevices?.getUserMedia) {
          qrRegion.textContent = "Tu navegador no permite acceder a la c치mara.";
          showMessage("La c치mara no est치 disponible en este navegador.", "error");
          return;
        }

        if (!("BarcodeDetector" in window)) {
          qrRegion.textContent = "La detecci칩n de QR no est치 disponible en este navegador.";
          showMessage("La lectura de QR requiere un navegador con BarcodeDetector.", "error");
          return;
        }

        try {
          detector = new BarcodeDetector({ formats: ["qr_code"] });
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          if (!videoEl) {
            videoEl = document.createElement("video");
            videoEl.className = "scanner";
            videoEl.setAttribute("autoplay", "true");
            videoEl.setAttribute("playsinline", "true");
          }
          qrRegion.innerHTML = "";
          qrRegion.appendChild(videoEl);
          videoEl.srcObject = stream;
          await videoEl.play();
          cameraRunning = true;
          document.getElementById("toggle-scan").textContent = "Detener c치mara";
          scanFrame();
        } catch (error) {
          console.error("No se pudo iniciar la c치mara", error);
          qrRegion.textContent = "No se pudo acceder a la c치mara.";
          showMessage("No se pudo iniciar la c치mara. Revisa los permisos del navegador.", "error");
          stopCamera();
        }
      }

      function init() {
        records = loadData();
        renderTable();
        updateScanPreview("", "");
        document.getElementById("check-btn").addEventListener("click", () => {
          const dniValue = document.getElementById("dni-input").value;
          registerEntry(dniValue);
        });
        document.getElementById("add-btn").addEventListener("click", addPerson);
        document.getElementById("file-input").addEventListener("change", handleFileInput);
        document.getElementById("upload-btn").addEventListener("click", () => {
          document.getElementById("file-input").click();
        });
        document.getElementById("download-btn").addEventListener("click", downloadData);
        document.getElementById("toggle-scan").addEventListener("click", toggleCamera);
        document.getElementById("confirm-scan").addEventListener("click", () => {
          if (!lastScannedDni) {
            showMessage("A칰n no hay un DNI detectado desde el QR.", "error");
            return;
          }
          registerEntry(lastScannedDni);
        });
        document.getElementById("dni-input").addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            registerEntry(e.target.value);
          }
        });
      }

      init();
  </script>
</body>
</html>
